#### 什么是兰伯特逻辑时钟

1978年兰伯特提出了逻辑时钟的概念，来解决分布式系统下的时钟和事件顺序问题

#### 逻辑时钟的意义
先说下为什么要有这个东西，它带来的作用是什么？

答案就是分布式系统下的数据一致性。当然要实现分布式系统下的分布式一致性还有很多工作要做，但是事件顺序一致性是一个根本。

假设有个存储系统需要做高可用，最直接想到的解决方案就是存储系统有多个副本，这样当主系统发生错误异常等导致服务不可用的时候，可以让副本系统继续对外提供服务。

通常副本数据存储在不同的物理计算机上面，主数据与副本数据之间进行数据同步通常是依靠网络通信来实现的。而我们知道网络通信是不可靠的，很有可能在物理时间上某些先发生的数据在通过网络进行同步的时候却是后到副本系统的(如下图)。这会带来一个问题，那就是副本上数据的顺序是不一致的。而这个当然是不被系统所允许的。

![avatar](https://img-blog.csdnimg.cn/img_convert/ad920f263162e70b6352d95e2d842696.png)

有同学可能会说我们直接使用物理时间不就行了吗，基于物理时间的先后来判断事件发生的先后顺序不就行了吗？不行！

为什么，一是因为不同计算机的物理时间是不一样的，二是因为物理时间的精确度不够

时间不一致比较好理解，现实生活中我们经常遇到需要。有的计算机时间快一些，即使1秒那也是快。

精确度不够怎么理解呢，程序中我们可以得到系统物理时间的时间戳，是微秒级别的，但在高并发情况下，多个事件在同一微秒内发生的概率是很高的。如果俩事件是同一微秒发生的，你怎么判断哪个先哪个后？

#### 逻辑时钟的算法思路
局部有序
既然时间无法作为事件发生先后的依据，那用什么来判断呢？

#### 逻辑时钟遵守的原则
这里有两个原则

```
原则1：同一计算机上发生的事件，先发生的在前

```
```
原则2：消息的发出一定是比接收要在前面的
```
有点儿抽象，看下图

![avatar](https://img-blog.csdnimg.cn/img_convert/2db5a63a79c6e7a228281edcdfb1a2da.png)

计算机1依次发生了a1，a2，a3事件，我们根据原则1能得出a1发生在a2之前，a2发生在a3之前。计算机2的三次事件的先后顺序也是如此。

根据原则2我们能得出a2发生在b2之前。

因此通过这个关系我们能得出
```
a1-->a2-->a3
```
```
b1-->b2-->b3
```
```
b1-->a2-->b2-->b3
```
#### 狭义相对论
这里我们不会依据事件发生的物理时间来判断顺序，而是依据的关系来判断的。根据关系判断发生先后也可以从狭义相对论找到依据。
```
狭义相对论告诉我们时空中的事件并不存在一个始终如一的全序关系；不同的观察者对两个事件谁先发生可能具有不同的看法。当且仅当事件e2是由事件e1引起的时候，事件e1和e2之间才存在一个先后关系。
```
#### 逻辑时钟的具体算法
通过上面的描述，我们可以想当然的得出下面的一个逻辑时钟算法

需要让同一个计算机的事件值比之前的高，这个比较简单

每一个计算机都有一个累加变量，新发生的事件+1

需要让消息接收者的值比发出高，这个可以把发出值作为参数放在消息中

接收消息的事件根据当前累加值和消息值做个处理，得出的值要大于等于消息值+1和累加值+1



#### 全局有序
通过上面的思路我们还不能得出一个全序关系，比如a1和b1到底谁先发生谁后发生是没有办法判断的，相对论也表明了这点。

但是我们可以自己制定一个大家都遵守的规则呀，比如给每一台计算机一个数字id，如果不同计算机的事件利用上述算法得出了相同的值，那么我们比较发出事件的计算机的id，id大发生在后面。(是不是很熟悉，zookeeper选主是不是就有这个点)

这样我们就可以得到一个全局的事件顺序了。

a1-->b1-->a2-->a3-->b2-->b3

#### 逻辑时钟与分布式锁
基本原理就是当多个人同时抢同一个资源的时候，我们让先请求的那个人先获取资源。谁先谁后就可以用到逻辑时钟了

这里并不存在一个中央的分配角色，而是让大家都认可这个分配。

多个人要使用同一个资源，抢的人给所有其他人发送请求，我要使用这个资源。当所有人都回复了，那么这个时候我就有资格获取资源了，具体能不能获取资源需要依据当前有没有别人比我先。如果我是最先请求的，那么我就获取资源。

当我要释放资源了，我也告诉所有人。这样别人就有机会使用资源了。

这里为了保证所有人手里抢资源事件发生时间的一致性，需要对逻辑时钟有一个修改(消息发生和接收的值是一致的)

#####【问题1】为什么要等所有人都回复了，才有机会获取资源

因为只有所有人都回复了，才代表所有人都知道我在获取资源了。反之，有一个人不知道我在获取资源，这个时候如果他是后请求的，但是他不知道有我的存在，它可能就会去拿资源了，这样就冲突了。

######【问题2】为什么要修改逻辑时钟，让消息发生和接收的值是一致的

避免了冲突，如果所有人的请求都是1，所有人的接收都是大于1，那么所有人都以为自己是最早的，如下



如果发出和接收是一个值，那么根据全局有序的定义，我们可以得出虽然都是1，但是当前时刻计算机1才是最先的，所以计算机1可以先获取资源。

##### 分布式一致性的问题
当然这种方式实现分布式锁，还是有很大的问题的，如果有一个计算机发生了异常，那么所有请求都无法满足，资源永远也不会获取。而且这种情况发生的概率非常大，这是分布式系统的本质，容错性很难得到保证。

所以为了实现分布式系统的一致性，为了在分布式系统下就某个值达成一致，达成共识，兰伯特提出了paxos算法。

参考：https://blog.csdn.net/weixin_39854326/article/details/112722184

具体论文pdf下载地址：https://lamport.azurewebsites.net/pubs/time-clocks.pdf