
#  P2PDB 白皮书                   

### 一、行业背景
##### 1、离线系统数据库
在实体行业，线下实体店需要多台收银系统，目前普遍的解决方案是采用在线收银系统，数据交换通过中心化的云服务器，当网络不佳、甚至出现断网时，直接会影响到线下实体店收入，导致线下实体店无法正常营业，而更好的解决方法应该是使用离线存储，当网络恢复后再将数据上报，那么离线情况下数据的一致性如何保障， 使用raft协议可以在离线的情况下通过局域网搭建离线存储网络，但是类似Raft Paxos 强一致性协议有着天然的缺陷，当节点一半以上不可用时，集群将无法工作，线下实体店的收银系统经常会开机及关机、在业务低峰期会关闭限制的收银机、服务器，因此需要一种更有效的解决方案。

##### 2、分布式边缘数据缓存
在全球化的今天，我们经常会浏览各个国家、省份的网站数据，由于服务器节点分布在全球不同范围，导致访问及慢，如从大陆访问美国服务器，具有高延迟。尽管CDNS厂商提供了分布式文件云存储，cdns费用高昂，不是每个网站都能支付得起费用，IPFS出现优化了这一问题，但是IPFS中的filecoin 仅仅只是解决了文件存储，对于交换数据要求快的数据库存储尚欠缺可行的方案。

##### 3、区块链数据存储
区块链提供了一种无法逆向、篡改、去中心化的数据存储方式，解决长期依赖需要具有强大的政治背景作为信任背书，让世人知道通过加密算法+共识协议也是可以被信赖，但是当前的共识协议，无论是工作量证明、权益证明，完成一次共识至少需要数分钟甚至几十分钟，对于延迟性要求低的业务，存在巨大的阻碍。


##### 4、多人在线协作
多人在线协作需解决相互冲突问题，基于CRDT的不可篡改日志，可根据Lamport 逻辑时钟自动解决冲突。



### 二、满足条件
要解决以上行业问题，需要实现以下目标
* 1、低延迟
* 2、支持成千上万台节点运行
* 3、高性能
* 4、点对点对等网络
* 5、可验证的数据结构
* 6、最终一致性机制
* 7、历史日志不可篡改
* 8、共识机制
* 9、单机查询qps 1万以上、写入qps 5千以上
* 10、开源
* 11、轻松升级和bug恢复
* 12、社区自治



### 三、技术原理摘要



#### CRDT 无冲突复制数据类型
由于可以使用直接传输进行在线和离线通信，因此必须有一种方法来保持所有消息之间的连贯性和顺序，尤其是在与多个参与者的对话中。例如，如果 Alice 和 Bob 与其他几个人在一个聊天组中，并且他们都因乘坐地铁而失去了互联网连接，那么他们仍然可以使用 BLE 在同一对话中相互通信，从而创建此对话的并行版本。当他们重新上线时，BLE 版本和 Internet 版本将不得不合并。因此，有必要使用一种算法来确保所有对等方在同步后具有完全相同的排序消息列表。

这个问题的解决方案是无冲突复制数据类型 (CRDT)，它是一种数据结构，允许在分布式系统上对消息进行一致的排序,CRDT 提供乐观复制和强最终一致性，确保一旦同步，每个对等点都将具有相同版本的消息列表。

每条消息都链接到其父级，这是此时连接在一起的对等方之一在对话中发送的最后一条消息。当对话的在线和离线版本同步时会出现问题：一些消息链接到同一个父级，链表变成有向无环图 。
[更多详情](./实现最终一致性数据库的协议.md)。

![avatar](https://d33wubrfki0l68.cloudfront.net/8563a307fdd30972608022cae35fdb94055b2f40/4fd9e/docs/protocol/bkfkkbdou_hub6782b1aaace488361b88eb59d953e58_133009_970x0_resize_q100_lanczos_2.webp)


这会导致创建几个最终需要合并的并行分支。 P2PDB 通过使用Lamport Clock 来实现这一点：每条消息将包含一个Lamport Clock，合并后的列表将根据其值进行排序。


#### Lamport 时钟
Lamport 时钟是一个包含两个字段的结构：一个身份公钥和一个计数器，该计数器为相关用户/身份发布的每条消息递增 [更多详情](./兰伯特的逻辑时钟.md)。

```
// golang
type lamportClock struct {
    time int
    id   crypto.PublicKey
}
```

比较函数很简单，它会首先检查计数器值之间的差距，如果没有，它会检查身份公钥之间的字典差距，知道给定的身份不能用相同的计数器发布两条消息价值。


```
// golang
func compareClock(a, b lamportClock) int {
    dist := a.time - b.time

    if dist == 0 {
        dist = comparePubKey(a.id, b.id) // Returns lexicographic distance
    }

    return dist
}
```
### 版本证明 VOS 
Proof of vension ,类似pos、存储证明的一种算法，存储版本最完整的节点可以打包区块，根据IPFS协议存储到全球范围不同的服务器节点，以达到数据永久保存的目的


### 日志不可篡改
不可篡改指的是，每次生成的变动日志，通过广播到所有节点，每过十分钟会被打包成一个块日志上传到区块链上，此时日志内容是无法进行篡改，参考以太坊、比特币协议


### 技术术语

##### 1、分布式共识
分布式共识是指，历史发生的数据变更不可篡改、节点每十分钟会达成一次共识，完成共识时变更日志会永久保存，每个节点都会保存一份完整的变更日志，同时会生成一份数据快照，用于快速恢复数据。

##### 2、版本证明
版本证明是指发生共识时，优先选择版本证明最完整的节点作为数据一致性校验的节点，剩余节点将根据数据版本最全的节点进行数据校对，最终生成数据快照和历史日志块

##### 3、轻节点
遵循默克尔有向无环图结构，对于边缘节点，只需要下载最近10分钟前的日志。

##### 4、数据存储快照及日志
存储变更日志（类似mysql binlog日志，每十分钟生成一次），数据快照（全量数据，用于快速恢复跟备份）

### 该白皮书参考论文
* Lamport time clock https://lamport.azurewebsites.net/pubs/time-clocks.pdf
* CRDT tech report: https://hal.inria.fr/file/index/docid/555588/filename/techreport.pdf